<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mickey Horror TPS</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
</head>
<body>
    <canvas id="gameCanvas" style="width:100%; height:100%; touch-action:none;"></canvas>
    <script type="module">
        import { createTerrifyingMickey } from './mickey.js'; // Import your detailed Mickey

        const canvas = document.getElementById("gameCanvas");
        const engine = new BABYLON.Engine(canvas, true);

        const createScene = () => {
            const scene = new BABYLON.Scene(engine);
            scene.collisionsEnabled = true;
            scene.gravity = new BABYLON.Vector3(0,-9.81,0);

            // ===== LIGHT =====
            const light = new BABYLON.SpotLight("spotLight", new BABYLON.Vector3(0,10,-10), new BABYLON.Vector3(0,-1,1), Math.PI/3, 2, scene);
            light.intensity = 2;

            // ===== FLOOR & WALLS =====
            const floor = BABYLON.MeshBuilder.CreateBox("floor", {width:50, height:1, depth:50}, scene);
            floor.position.y = -0.5; floor.checkCollisions = true;

            const wallOptions = {width:50, height:10, depth:1};
            const frontWall = BABYLON.MeshBuilder.CreateBox("frontWall", wallOptions, scene); frontWall.position.set(0,5,25); frontWall.checkCollisions=true;
            const backWall = BABYLON.MeshBuilder.CreateBox("backWall", wallOptions, scene); backWall.position.set(0,5,-25); backWall.checkCollisions=true;
            const sideWallOptions = {width:1, height:10, depth:50};
            const leftWall = BABYLON.MeshBuilder.CreateBox("leftWall", sideWallOptions, scene); leftWall.position.set(-25,5,0); leftWall.checkCollisions=true;
            const rightWall = BABYLON.MeshBuilder.CreateBox("rightWall", sideWallOptions, scene); rightWall.position.set(25,5,0); rightWall.checkCollisions=true;

            // ===== CREATE TERRIFYING MICKEY =====
            const {body:player, axe} = createTerrifyingMickey(scene, new BABYLON.Vector3(0,1,0));

            // ===== CAMERA (TPS) =====
            const camera = new BABYLON.FreeCamera("TPSCamera", new BABYLON.Vector3(1.5,2.5,-4), scene);
            camera.lockedTarget = player;
            camera.attachControl(canvas, true);
            camera.checkCollisions = true;
            camera.applyGravity = true;

            // ===== INPUT HANDLING =====
            const inputMap = {};
            scene.actionManager = new BABYLON.ActionManager(scene);
            scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, evt => inputMap[evt.sourceEvent.key] = true));
            scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, evt => inputMap[evt.sourceEvent.key] = false));

            // ===== AXE SWING =====
            let canSwing = true;
            scene.onPointerObservable.add(pointerInfo => {
                if(pointerInfo.type === BABYLON.PointerEventTypes.POINTERDOWN && canSwing){
                    canSwing = false;
                    axe.rotation.z = -Math.PI/3;
                    setTimeout(() => { axe.rotation.z = -Math.PI/4; }, 200);

                    // Raycast for enemy hits
                    const origin = axe.getAbsolutePosition();
                    const forward = new BABYLON.Vector3(0,0,1);
                    forward.applyRotationMatrix(axe.getWorldMatrix());
                    const ray = new BABYLON.Ray(origin, forward, 2);
                    const hit = scene.pickWithRay(ray, mesh => mesh.name.startsWith("enemy"));
                    if(hit.pickedMesh) hit.pickedMesh.dispose();

                    setTimeout(()=> canSwing=true, 600);
                }
            });

            // ===== PLAYER MOVEMENT =====
            const speed = 5;
            scene.onBeforeRenderObservable.add(() => {
                const delta = engine.getDeltaTime()/1000;
                let move = new BABYLON.Vector3.Zero();
                if(inputMap["w"]) move.z += 1;
                if(inputMap["s"]) move.z -= 1;
                if(inputMap["a"]) move.x -= 1;
                if(inputMap["d"]) move.x += 1;

                if(move.length()>0){
                    move.normalize();
                    const camMatrix = camera.getWorldMatrix();
                    const forward = camMatrix.getRow(2).scale(-1); forward.y=0; forward.normalize();
                    const right = camMatrix.getRow(0); right.y=0; right.normalize();
                    const direction = forward.scale(move.z).add(right.scale(move.x));
                    player.moveWithCollisions(direction.scale(speed*delta));
                    player.rotation.y = Math.atan2(direction.x, direction.z);
                }
            });

            // ===== ENEMY PLACEHOLDER =====
            const enemy = BABYLON.MeshBuilder.CreateCapsule("enemy1", {height:2, radius:0.5}, scene);
            enemy.position.set(5,1,5); enemy.checkCollisions = true;

            return scene;
        };

        const scene = createScene();
        engine.runRenderLoop(() => scene.render());
        window.addEventListener("resize", () => engine.resize());
    </script>
</body>
</html>
