<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mickey Horror TPS</title>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
</head>
<body>
<canvas id="gameCanvas" style="width:100%;height:100%;touch-action:none;"></canvas>
<script type="module">
import { createTerrifyingMickey } from './mickey.js';

const canvas = document.getElementById("gameCanvas");
const engine = new BABYLON.Engine(canvas, true);

const createScene = () => {
    const scene = new BABYLON.Scene(engine);
    scene.collisionsEnabled = true;
    scene.gravity = new BABYLON.Vector3(0,-9.81,0);

    // ===== LIGHTS =====
    const light = new BABYLON.SpotLight("spotLight", new BABYLON.Vector3(0,15,-10), new BABYLON.Vector3(0,-1,1), Math.PI/3, 2, scene);
    light.intensity = 2;

    // ===== MAP =====
    const floor = BABYLON.MeshBuilder.CreateGround("floor", {width:50, height:50}, scene);
    floor.checkCollisions = true;

    // Some elevated platforms
    for(let i=0;i<3;i++){
        const plat = BABYLON.MeshBuilder.CreateBox("platform"+i, {width:10, height:1, depth:10}, scene);
        plat.position.set(i*12 - 12,1.5 + i, i*5 - 5);
        plat.checkCollisions = true;
    }

    // Walls around
    const wallOptions = {width:50, height:10, depth:1};
    const frontWall = BABYLON.MeshBuilder.CreateBox("frontWall", wallOptions, scene); frontWall.position.set(0,5,25); frontWall.checkCollisions=true;
    const backWall = BABYLON.MeshBuilder.CreateBox("backWall", wallOptions, scene); backWall.position.set(0,5,-25); backWall.checkCollisions=true;
    const leftWall = BABYLON.MeshBuilder.CreateBox("leftWall", {width:1, height:10, depth:50}, scene); leftWall.position.set(-25,5,0); leftWall.checkCollisions=true;
    const rightWall = BABYLON.MeshBuilder.CreateBox("rightWall", {width:1, height:10, depth:50}, scene); rightWall.position.set(25,5,0); rightWall.checkCollisions=true;

    // ===== CREATE MICKEY =====
    const {body:player, axe} = createTerrifyingMickey(scene, new BABYLON.Vector3(0,1,0));

    // ===== CAMERA =====
    const camera = new BABYLON.FreeCamera("TPSCamera", new BABYLON.Vector3(1.5,2.5,-4), scene);
    camera.lockedTarget = player;
    camera.attachControl(canvas,true);
    camera.checkCollisions = true;
    camera.applyGravity = true;

    // ===== INPUT =====
    const inputMap = {};
    scene.actionManager = new BABYLON.ActionManager(scene);
    scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, evt=>inputMap[evt.sourceEvent.key]=true));
    scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, evt=>inputMap[evt.sourceEvent.key]=false));

    // ===== AXE SWING =====
    let canSwing = true;
    scene.onPointerObservable.add(pi=>{
        if(pi.type===BABYLON.PointerEventTypes.POINTERDOWN && canSwing){
            canSwing=false;
            axe.rotation.z = -Math.PI/3;
            setTimeout(()=>axe.rotation.z=-Math.PI/4,200);
            setTimeout(()=>canSwing=true,600);
        }
    });

    // ===== PLAYER MOVEMENT =====
    const speed = 5;
    scene.onBeforeRenderObservable.add(()=>{
        const delta = engine.getDeltaTime()/1000;
        let move = new BABYLON.Vector3.Zero();
        if(inputMap["w"]) move.z+=1;
        if(inputMap["s"]) move.z-=1;
        if(inputMap["a"]) move.x-=1;
        if(inputMap["d"]) move.x+=1;

        if(move.length()>0){
            move.normalize();
            const camMatrix = camera.getWorldMatrix();
            const forward = camMatrix.getRow(2).scale(-1); forward.y=0; forward.normalize();
            const right = camMatrix.getRow(0); right.y=0; right.normalize();
            const dir = forward.scale(move.z).add(right.scale(move.x));
            player.moveWithCollisions(dir.scale(speed*delta));
            player.rotation.y = Math.atan2(dir.x, dir.z);
        }
    });

    // ===== ENEMIES PLACEHOLDER =====
    const enemy1 = BABYLON.MeshBuilder.CreateCapsule("enemy1",{height:2, radius:0.5}, scene);
    enemy1.position.set(10,1,10); enemy1.checkCollisions = true;

    return scene;
};

const scene = createScene();
engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
